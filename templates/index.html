<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mutual Fund Scheme Search</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background-color: #f9f9f9;
    }
    input[type="text"] {
      width: 100%;
      max-width: 400px;
      padding: 10px;
      font-size: 16px;
      box-sizing: border-box;
    }
    .suggestions {
      border: 1px solid #ccc;
      max-height: 200px;
      overflow-y: auto;
      width: 100%;
      max-width: 400px;
      position: absolute;
      background: white;
      z-index: 999;
    }
    .suggestions div {
      padding: 8px;
      cursor: pointer;
    }
    .suggestions div:hover {
      background: #f0f0f0;
    }
    .suggestions div strong {
      color: #007bff;
    }
    .scheme-details {
      margin-top: 40px;
      background-color: white;
      padding: 20px;
      width: 100%;
      max-width: 600px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    #loading {
      margin-left: 10px;
    }
    @media (max-width: 600px) {
      body {
        margin: 20px;
      }
      .scheme-details {
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <h1>üîç Search Mutual Fund Scheme</h1>
  <form method="POST" autocomplete="off">
    <input type="text" id="scheme_name" name="scheme_name" placeholder="Start typing scheme name..." aria-label="Search mutual fund schemes" required>
    <div id="suggestions" class="suggestions" role="listbox"></div>
    <button type="submit" id="submitBtn" style="margin-top: 10px;">Search</button>
    <button type="button" id="clearBtn" style="margin-top: 10px; margin-left: 5px;">Clear</button>
    <span id="loading" style="display: none;">Loading...</span>
  </form>

  <div class="scheme-details" id="schemeDetails" style="display: none;">
    <h2 id="schemeName"></h2>
    <p><strong>Fund House:</strong> <span id="fundHouse"></span></p>
    <p><strong>Scheme Type:</strong> <span id="schemeType"></span></p>
    <p><strong>Category:</strong> <span id="schemeCategory"></span></p>
    <h3>üìà Last 5 NAVs:</h3>
    <ul id="navList"></ul>
    <canvas id="navChart" width="600" height="300"></canvas>
  </div>
  <p id="error" style="color: red; display: none;"></p>

  <script>
    // Mock data with more Axis funds
    const allSchemes = [
      { scheme_name: "Axis Bluechip Fund" },
      { scheme_name: "Axis Small Cap Fund" },
      { scheme_name: "Axis Long Term Equity Fund" },
      { scheme_name: "Axis Midcap Fund" },
      { scheme_name: "SBI Bluechip Fund" },
      { scheme_name: "HDFC Small Cap Fund" },
      { scheme_name: "ICICI Prudential Balanced Advantage" },
      { scheme_name: "Mirae Asset Large Cap Fund" }
    ];

    // Mock scheme data for Axis Small Cap Fund
    const mockSchemeData = {
      meta: {
        scheme_name: "Axis Small Cap Fund",
        fund_house: "Axis Mutual Fund",
        scheme_type: "Equity",
        scheme_category: "Small Cap"
      },
      data: [
        { date: "2025-07-09", nav: 32.456 },
        { date: "2025-07-10", nav: 32.789 },
        { date: "2025-07-11", nav: 33.123 },
        { date: "2025-07-12", nav: 33.567 },
        { date: "2025-07-13", nav: 34.012 }
      ]
    };

    const input = document.getElementById('scheme_name');
    const suggestions = document.getElementById('suggestions');
    const form = document.querySelector('form');
    const submitBtn = document.getElementById('submitBtn');
    const clearBtn = document.getElementById('clearBtn');
    const loading = document.getElementById('loading');
    const schemeDetails = document.getElementById('schemeDetails');
    const error = document.getElementById('error');

    let timeout;
    input.addEventListener('input', () => {
      clearTimeout(timeout);
      timeout = setTimeout(() => {
        const query = input.value.trim().toLowerCase();
        suggestions.innerHTML = '';
        if (query.length === 0) return;

        if (!allSchemes || !Array.isArray(allSchemes)) {
          suggestions.innerHTML = '<div>No schemes available</div>';
          return;
        }

        // Split query into terms
        const terms = query.split(/\s+/).filter(term => term.length > 0);

        // Filter schemes where all terms appear in scheme_name
        const matches = allSchemes.filter(s => {
          const name = s.scheme_name.toLowerCase();
          return terms.every(term => name.includes(term));
        }).slice(0, 50);

        // Use Fuse.js for fuzzy matching if no exact matches
        if (matches.length === 0) {
          const fuse = new Fuse(allSchemes, { keys: ['scheme_name'], threshold: 0.4 });
          matches.push(...fuse.search(query).map(result => result.item).slice(0, 50));
        }

        matches.forEach(match => {
          const div = document.createElement('div');
          let displayName = match.scheme_name;
          terms.forEach(term => {
            const regex = new RegExp(`(${term})`, 'gi');
            displayName = displayName.replace(regex, '<strong>$1</strong>');
          });
          div.innerHTML = displayName;
          div.addEventListener('click', () => {
            input.value = match.scheme_name;
            suggestions.innerHTML = '';
          });
          suggestions.appendChild(div);
        });
      }, 300);
    });

    document.addEventListener('click', e => {
      if (!suggestions.contains(e.target) && e.target !== input) {
        suggestions.innerHTML = '';
      }
    });

    clearBtn.addEventListener('click', () => {
      input.value = '';
      suggestions.innerHTML = '';
      schemeDetails.style.display = 'none';
      error.style.display = 'none';
    });

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const query = input.value.trim();
      const exactMatch = allSchemes.some(s => s.scheme_name === query);
      if (!exactMatch) {
        const fuse = new Fuse(allSchemes, { keys: ['scheme_name'], threshold: 0.4 });
        const suggestions = fuse.search(query).map(result => result.item.scheme_name).slice(0, 3);
        error.innerHTML = `No matching scheme found for "${query}". Did you mean: ${suggestions.join(', ') || 'no similar schemes'}?`;
        error.style.display = 'block';
        schemeDetails.style.display = 'none';
        return;
      }

      submitBtn.disabled = true;
      loading.style.display = 'inline';

      setTimeout(() => {
        const schemeData = query === "Axis Small Cap Fund" ? mockSchemeData : null;

        submitBtn.disabled = false;
        loading.style.display = 'none';

        if (schemeData) {
          error.style.display = 'none';
          schemeDetails.style.display = 'block';
          document.getElementById('schemeName').textContent = schemeData.meta.scheme_name;
          document.getElementById('fundHouse').textContent = schemeData.meta.fund_house;
          document.getElementById('schemeType').textContent = schemeData.meta.scheme_type;
          document.getElementById('schemeCategory').textContent = schemeData.meta.scheme_category;

          const navList = document.getElementById('navList');
          navList.innerHTML = schemeData.data.map(nav => `<li>${nav.date} ‚Äì ‚Çπ${nav.nav.toFixed(3)}</li>`).join('');

          const ctx = document.getElementById('navChart').getContext('2d');
          new Chart(ctx, {
            type: 'line',
            data: {
              labels: schemeData.data.map(item => item.date),
              datasets: [{
                label: 'NAV (‚Çπ)',
                data: schemeData.data.map(item => item.nav),
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                fill: true,
              }]
            },
            options: {
              responsive: true,
              scales: {
                x: { title: { display: true, text: 'Date' } },
                y: { title: { display: true, text: 'NAV (‚Çπ)' } }
              }
            }
          });
        } else {
          error.style.display = 'block';
          schemeDetails.style.display = 'none';
        }
      }, 1000);
    });
  </script>
</body>
</html>
